
// ==UserScript==
// @name         Bad Apple on Finviz
// @version      0.1
// @description  Play bad Apple on Finviz
// @author       Joona
// @include      https://finviz.com/map.ashx*
// @grant        GM_addElement
// @run-at       document-start
// ==/UserScript==

// The code is minified. For the source code, visit https://github.com/Masterjoona/finviz-badapple

unsafeWindow.badAppleConfig = {
  customColors: false,
  negativeColor: "#000000",
  positiveColor: "#ffffff",
};


(()=>{function _(s,e){return!(e instanceof Array?e:[e]).some(a=>a instanceof RegExp?!a.test(s):!s.includes(a))}var p=class{constructor(e){if(this.chunkObject="webpackChunk_finviz_website",this.patches=e,this.patchesToApply=new Set,this.patches)for(let t of this.patches){if(t.replace instanceof Array){for(let a in t.replace)this.patchesToApply.add({name:t.name+"_"+a,find:t.find,replace:t.replace[a]});continue}this.patchesToApply.add(t)}}_interceptWebpackModern(){let e=unsafeWindow[this.chunkObject],t=this;Object.defineProperty(unsafeWindow,this.chunkObject,{set:function(r){if(e=r,!r.push.__wpt_injected){e=r;let n=r.push;r.push=function(c){return c.__wpt_processed||(c.__wpt_processed=!0,t._patchModules(c[1])),n.apply(this,arguments)},r.push.__wpt_injected=!0,n===Array.prototype.push?console.log("[patcher] FInjected "+t.chunkObject+" (before webpack runtime)"):console.log("[patcher] FInjected "+t.chunkObject+" (at webpack runtime)")}},get:function(){return e},configurable:!0})}_patchModules(e){for(let t in e){if(e[t].__wpt_processed)continue;let a=Function.prototype.toString.apply(e[t]),r=[];for(let n of this.patchesToApply)_(a,n.find)&&(n.replace.predicate===void 0||n.replace.predicate)&&(console.log("[patcher] Found patch: "+n.name),r.push(n),this.patchesToApply.delete(n));for(let n of r)a=a.replace(n.replace.match,n.replace.replacement);if(r.length>0){let n="";r.length>0&&(n+="Patched by: "+r.map(c=>c.name).join(", ")),e[t]=new Function("module","exports","webpackRequire",`(${a}).apply(this, arguments)
// ${n}
//# sourceURL=${this.chunkObject}-Module-${t}`),e[t].__wpt_patched=!0}e[t].__wpt_funcStr=a,e[t].__wpt_processed=!0}}};var b=33.333333333333336,d=class{constructor(){this.precalculatedFrames=[],this.badAppleFrames=null,this.frameIndex=0,this.lastFrameTime=0}async fetchBadAppleFrames(){try{let e=await fetch("https://pawst.eu/p/pigeon-spider-fly/f/all_new_frames.json");this.badAppleFrames=await e.json()}catch(e){console.error("Failed to fetch Bad Apple frames:",e)}}preCalculate(){let{width:e,height:t,nodes:a}=unsafeWindow.treemapper;this.badAppleFrames.forEach((r,n)=>{let c=a.map(i=>{let f=unsafeWindow.treemapper.getParentSector(i),m=i.x+i.dx/2,w=i.y+i.dy/2,y=Math.floor(m/e*20),l=Math.floor(w/t*36),A=(r[l]&&r[l][y])===1?3:-3;return{name:i.name,data:{sector:f},perf:A,additional:void 0}});this.precalculatedFrames.push({hash:`frame-${n}`,nodes:c})})}playPrecomputed(e){e-this.lastFrameTime>=b&&(unsafeWindow.treemapper.updatePerf(this.precalculatedFrames[this.frameIndex]),unsafeWindow.updateTick(t=>t+1),this.frameIndex=(this.frameIndex+1)%this.precalculatedFrames.length,this.lastFrameTime=e),requestAnimationFrame(this.playPrecomputed.bind(this))}syncWithVideo(e){let t=()=>{if(!this.precalculatedFrames.length)return;let a=Math.floor(e.currentTime*30);a<this.precalculatedFrames.length&&(unsafeWindow.treemapper.updatePerf(this.precalculatedFrames[a]),unsafeWindow.updateTick?.(r=>r+1)),requestAnimationFrame(t)};requestAnimationFrame(t)}async start(){return await this.fetchBadAppleFrames(),this.badAppleFrames&&(this.preCalculate(),requestAnimationFrame(this.playPrecomputed.bind(this))),!0}},h=()=>{new d().start()},u=async()=>{let s=new d,e=document.createElement("video");e.src="https://pawst.eu/p/pigeon-spider-fly/f/badapple.mp4",e.load(),e.style.position="fixed",e.style.bottom="38px",e.style.left="360px",e.style.width="300px",e.style.height="auto",e.style.zIndex="9999",e.style.opacity="0.5",document.body.appendChild(e),await s.start(),await e.play(),s.syncWithVideo(e)};unsafeWindow.customColorScale=s=>o?s<0?unsafeWindow.badAppleConfig.negativeColor:unsafeWindow.badAppleConfig.positiveColor:unsafeWindow.treemapper.colorScale(s);var F=[{name:"React Updater",find:"window.MAP_EXPORT",replace:{match:/dataHash:\w}=\w;(?=.+?(\w)\.useState)/,replacement:"$&let [tick,setTick]=$1.useState(0);window.updateTick=setTick;"}},{name:"Expose Treemap",find:"this._updateIndustryPerf():this._resetIndustryPerf(),",replace:[{match:/;this.width=/,replacement:";window.treemapper=this;$&"},{match:/this\.colorScale\((\w\.perf)\)/,predicate:unsafeWindow.badAppleConfig.customColors,replacement:"window.customColorScale($1)"}]},{name:"Industry Header color",find:"&&this.renderSectorBorders",replace:{match:/fill:\w\.colorScale\((\w.perf)\)/,predicate:unsafeWindow.badAppleConfig.customColors,replacement:"fill:window.customColorScale($1)"}}],g=new p(F);g._interceptWebpackModern();var o=!1;unsafeWindow.startBadApple=()=>(o||(o=!0,h()),o);unsafeWindow.startBadAppleWithAudioAndVideo=async()=>(o||(o=!0,await u()),o);})();
