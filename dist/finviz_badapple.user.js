
// ==UserScript==
// @name         Bad Apple on Finviz
// @version      0.1
// @description  Play bad Apple on Finviz
// @author       Joona
// @include      https://finviz.com/map.ashx*
// @grant        GM_addElement
// @run-at       document-start
// ==/UserScript==

// The code is minified. For the source code, visit https://github.com/Masterjoona/finviz-badapple

unsafeWindow.badAppleConfig = {
  customColors: false,
  negativeColor: "#000000",
  positiveColor: "#ffffff",
};


(()=>{function A(s,e){return!(e instanceof Array?e:[e]).some(n=>n instanceof RegExp?!n.test(s):!s.includes(n))}var p=class{constructor(e){if(this.chunkObject="webpackChunk_finviz_website",this.patches=e,this.patchesToApply=new Set,this.patches)for(let t of this.patches){if(t.replace instanceof Array){for(let n in t.replace)this.patchesToApply.add({name:t.name+"_"+n,find:t.find,replace:t.replace[n]});continue}this.patchesToApply.add(t)}}_interceptWebpackModern(){let e=unsafeWindow[this.chunkObject],t=this;Object.defineProperty(unsafeWindow,this.chunkObject,{set:function(r){if(e=r,!r.push.__wpt_injected){e=r;let a=r.push;r.push=function(o){return o.__wpt_processed||(o.__wpt_processed=!0,t._patchModules(o[1])),a.apply(this,arguments)},r.push.__wpt_injected=!0,a===Array.prototype.push?console.log("[patcher] FInjected "+t.chunkObject+" (before webpack runtime)"):console.log("[patcher] FInjected "+t.chunkObject+" (at webpack runtime)")}},get:function(){return e},configurable:!0})}_patchModules(e){for(let t in e){if(e[t].__wpt_processed)continue;let n=Function.prototype.toString.apply(e[t]),r=[];for(let a of this.patchesToApply)A(n,a.find)&&(a.replace.predicate===void 0||a.replace.predicate)&&(console.log("[patcher] Found patch: "+a.name),r.push(a),this.patchesToApply.delete(a));for(let a of r)n=n.replace(a.replace.match,a.replace.replacement);if(r.length>0){let a="";r.length>0&&(a+="Patched by: "+r.map(o=>o.name).join(", ")),e[t]=new Function("module","exports","webpackRequire",`(${n}).apply(this, arguments)
// ${a}
//# sourceURL=${this.chunkObject}-Module-${t}`),e[t].__wpt_patched=!0}e[t].__wpt_funcStr=n,e[t].__wpt_processed=!0}}};var b=33.333333333333336,l=class{constructor(){this.precalculatedFrames=[],this.badAppleFrames=null,this.frameIndex=0,this.lastFrameTime=0}async fetchBadAppleFrames(){try{let e=await fetch("https://pawst.eu/p/pigeon-spider-fly/f/all_new_frames.json");this.badAppleFrames=await e.json()}catch(e){console.error("Failed to fetch Bad Apple frames:",e)}}preCalculate(){let{width:e,height:t,nodes:n}=unsafeWindow.treemapper;this.badAppleFrames.forEach((r,a)=>{let o=n.map(i=>{let f=unsafeWindow.treemapper.getParentSector(i),m=i.x+i.dx/2,w=i.y+i.dy/2,y=Math.floor(m/e*20),d=Math.floor(w/t*36),_=(r[d]&&r[d][y])===1?3:-3;return{name:i.name,data:{sector:f},perf:_,additional:void 0}});this.precalculatedFrames.push({hash:`frame-${a}`,nodes:o})})}playPrecomputed(e){e-this.lastFrameTime>=b&&(unsafeWindow.treemapper.updatePerf(this.precalculatedFrames[this.frameIndex]),unsafeWindow.updateTick(t=>t+1),this.frameIndex=(this.frameIndex+1)%this.precalculatedFrames.length,this.lastFrameTime=e),requestAnimationFrame(this.playPrecomputed.bind(this))}syncWithVideo(e){let t=()=>{if(!this.precalculatedFrames.length)return;let n=Math.floor(e.currentTime*30);n<this.precalculatedFrames.length&&(unsafeWindow.treemapper.updatePerf(this.precalculatedFrames[n]),unsafeWindow.updateTick(r=>r+1)),requestAnimationFrame(t)};requestAnimationFrame(t)}async start(){return await this.fetchBadAppleFrames(),this.badAppleFrames&&(this.preCalculate(),requestAnimationFrame(this.playPrecomputed.bind(this))),!0}},h=()=>{new l().start()},u=async()=>{let s=new l,e=document.createElement("video");e.src="https://pawst.eu/p/pigeon-spider-fly/f/badapple.mp4",e.volume=.1,e.load(),e.style.position="fixed",e.style.bottom="38px",e.style.left="360px",e.style.width="300px",e.style.height="auto",e.style.zIndex="9999",e.style.opacity="1",e.style.cursor="move";let t=!1,n=0,r=0;e.addEventListener("mousedown",a=>{t=!0,n=a.clientX-e.getBoundingClientRect().left,r=a.clientY-e.getBoundingClientRect().top,a.preventDefault()}),document.addEventListener("mousemove",a=>{t&&(e.style.left=`${a.clientX-n}px`,e.style.top=`${a.clientY-r}px`,e.style.bottom="auto")}),document.addEventListener("mouseup",()=>{t=!1}),document.body.appendChild(e),await s.fetchBadAppleFrames(),s.preCalculate(),await e.play(),s.syncWithVideo(e)};unsafeWindow.customColorScale=s=>c?s<0?unsafeWindow.badAppleConfig.negativeColor:unsafeWindow.badAppleConfig.positiveColor:unsafeWindow.treemapper.colorScale(s);var g=[{name:"React Updater",find:"window.MAP_EXPORT",replace:{match:/dataHash:\w}=\w;(?=.+?(\w)\.useState)/,replacement:"$&let [tick,setTick]=$1.useState(0);window.updateTick=setTick;"}},{name:"Expose Treemap",find:"this._updateIndustryPerf():this._resetIndustryPerf(),",replace:[{match:/;this.width=/,replacement:";window.treemapper=this;$&"},{match:/this\.colorScale\((\w\.perf)\)/,predicate:unsafeWindow.badAppleConfig.customColors,replacement:"window.customColorScale($1)"}]},{name:"Industry Header color",find:"&&this.renderSectorBorders",replace:{match:/fill:\w\.colorScale\((\w.perf)\)/,predicate:unsafeWindow.badAppleConfig.customColors,replacement:"fill:window.customColorScale($1)"}}],F=new p(g);F._interceptWebpackModern();var c=!1;unsafeWindow.startBadApple=()=>(c||(c=!0,h()),c);unsafeWindow.startBadAppleWithVideo=async()=>(c||(c=!0,await u()),c);})();
